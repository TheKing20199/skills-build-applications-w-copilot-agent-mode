{% extends 'base.html' %}
{% block title %}House Details{% endblock %}
{% block content %}
<!-- How It Works Section -->
<div style="background:#f7fafd;border:1px solid #4fc3f7;border-radius:12px;padding:1.2em 1.5em;margin-bottom:1.5em;max-width:600px;">
  <h2 style="margin-top:0;">How It Works 🏆</h2>
  <ul style="list-style:none;padding-left:0;">
    <li>🏠 <b>Join a House:</b> Compete with friends, rack up points, and climb the leaderboard.</li>
    <li>➕ <b>Log Activities:</b> Every workout counts—track your streaks and earn rewards.</li>
    <li>🤖 <b>Chat with OctoCoach:</b> Get instant feedback, encouragement, and smart recommendations.</li>
    <li>⚡ <b>Take on Challenges:</b> Accept daily/weekly challenges and help your house win.</li>
    <li>🎉 <b>Celebrate Milestones:</b> Hit a streak? Get confetti, emojis, and badges—Arnold style!</li>
  </ul>
</div>
<!-- Personalized Greeting & Motivation -->
<div style="font-size:1.2em;margin-bottom:1em;color:#1976d2;">
  <b>Welcome, {{ user.username }}!</b> You’re representing <b>House {{ house.name }}</b>.<br>
  <span style="font-size:1.05em;">{{ motivational_quote }}</span>
</div>
<!-- Quick Stats with Tooltips -->
<div style="display:flex;gap:2em;flex-wrap:wrap;margin-bottom:1.5em;align-items:center;">
  <div style="min-width:120px;">
    <b>Points <span title="Earned by logging activities and completing challenges. Help your house climb the leaderboard!">ℹ️</span>:</b>
    <span id="house-detail-points">{{ house.points }}</span>
  </div>
  <div style="min-width:120px;">
    <b>Streak <span title="Log activities on consecutive days to build your streak and unlock rewards!">ℹ️</span>:</b>
    {{ user_streak }} days
  </div>
  <div style="min-width:120px;">
    <b>Leaderboard <span title="See who’s leading your house!">ℹ️</span>:</b>
    <a href="/leaderboard">View</a>
  </div>
</div>
<!-- Progress Toward Next Goal -->
<div style="margin-bottom:1.5em;">
  <div style="margin-bottom:0.5em;">
    <b>Progress:</b>
    <div style="margin:0.3em 0 0.2em 0;">
      <span>🏋️‍♂️ Only {{ workouts_to_streak }} more workouts to reach a 7-day streak and earn a badge!</span><br>
      <span>🏆 Your house needs {{ points_to_lead }} more points to take the lead from {{ leading_house_name }}!</span>
    </div>
    <div style="background:#e0e7ef;height:8px;border-radius:4px;overflow:hidden;margin-bottom:8px;width:220px;">
      <div style="background:linear-gradient(90deg,#4fc3f7,#81d4fa);height:100%;width:{{ workouts_progress_percent }}%;transition:width 0.5s;"></div>
    </div>
    <div style="background:#e0e7ef;height:8px;border-radius:4px;overflow:hidden;margin-bottom:8px;width:220px;">
      <div style="background:linear-gradient(90deg,#81d4fa,#4fc3f7);height:100%;width:{{ streak_progress_percent }}%;transition:width 0.5s;"></div>
    </div>
    <div style="background:#e0e7ef;height:8px;border-radius:4px;overflow:hidden;margin-bottom:8px;width:220px;">
      <div style="background:linear-gradient(90deg,#4fc3f7,#1976d2);height:100%;width:{{ house_points_progress_percent }}%;transition:width 0.5s;"></div>
    </div>
  </div>
</div>
<!-- Calls to Action -->
{% if user_workouts_this_week == 0 %}
  <div style="background:#fffbe7;border:1px solid #ffd600;border-radius:8px;padding:1em 1.2em;margin-bottom:1.2em;font-size:1.1em;">
    <b>Start strong!</b> <a href="/submit-activity/" style="color:#1976d2;text-decoration:underline;">Log your first activity</a> to earn points for your house!
  </div>
{% endif %}
{% if not challenge_progress.accepted %}
  <div style="background:#e3f7fc;border:1px solid #4fc3f7;border-radius:8px;padding:1em 1.2em;margin-bottom:1.2em;font-size:1.1em;">
    <b>Take on a challenge!</b> 
    <a href="#challenges" style="color:#1976d2;text-decoration:underline;">Accept your first challenge</a>
    {% if challenges and challenges.0 and not challenges.0.is_accepted %}
      <button id="accept-first-challenge-btn" data-challenge-desc="{{ challenges.0.text|escapejs }}" style="margin-left:1em;background:#1976d2;color:#fff;border:none;border-radius:5px;padding:0.3em 1em;cursor:pointer;">Start Challenge</button>
    {% endif %}
    and help your house win!
  </div>
{% endif %}
<!-- Visualize Achievements -->
<h2>Achievements</h2>
<div style="display:flex;flex-wrap:wrap;gap:1em;">
  {% for badge in badges %}
    <div style="background:#f7fafd;border:1px solid #4fc3f7;border-radius:8px;padding:0.7em 1.2em;min-width:120px;text-align:center;">
      <div style="font-size:2em;">{{ badge.emoji }}</div>
      <div style="font-weight:bold;">{{ badge.name }}</div>
      <div style="font-size:0.95em;color:#888;">{{ badge.desc }}</div>
      {% if badge.id in user_badge_ids %}<span style="color:green;">Unlocked ✔️</span>{% else %}<span style="color:#aaa;">Locked 🔒</span>{% endif %}
    </div>
  {% endfor %}
</div>

<h1>House: {{ house.name }}</h1>
<a href="/submit-activity/" class="log-activity-btn" style="display:inline-block;background:#1976d2;color:#fff;padding:0.7em 1.5em;border-radius:8px;font-size:1.1em;margin-bottom:1.5em;text-decoration:none;">➕ Log Activity</a>
<p><strong>Mascot:</strong> {{ house.mascot }}</p>
<p><strong>Theme:</strong> {{ house.theme }}</p>
<p><strong>Description:</strong> {{ house.description }}</p>
<p><strong>Points:</strong> <span id="house-detail-points">{{ house.points }}</span></p>

{# Switch House Button #}
<form method="post" action="/join_house/" style="margin:1em 0;">
  {% csrf_token %}
  <input type="hidden" name="house_id" value="{{ house.id }}">
  <button type="submit" style="background:#4fc3f7;color:#fff;border:none;border-radius:6px;padding:0.5em 1.2em;font-size:1em;cursor:pointer;">Switch to {{ house.name }}</button>
</form>

{# Activities #}
{% if activities %}
  <h2>House Activities</h2>
  <ul>
    {% for activity in activities %}
      <li>{{ activity }}</li>
    {% endfor %}
  </ul>
{% endif %}

{# Challenges #}
{% if challenges %}
  <h2 id="challenges">House Challenges</h2>
  <ul style="list-style:none;padding-left:0;">
    {% for challenge in challenges %}
      <li style="margin-bottom:1.2em;">
        <div style="display:flex;align-items:center;gap:1em;">
          <span>{{ challenge.text }}</span>
          <div style="flex:1;max-width:180px;">
            <div class="challenge-progress-bar" style="background:#e0e7ef;height:8px;border-radius:4px;overflow:hidden;width:100%;">
              <div class="challenge-progress-fill" data-status="{% if challenge.is_completed %}completed{% elif challenge.is_accepted %}in_progress{% else %}not_started{% endif %}" style="height:100%;width:{% if challenge.is_completed %}100{% elif challenge.is_accepted %}50{% else %}0{% endif %}%;background:linear-gradient(90deg,#4fc3f7,#81d4fa);transition:width 1s;"></div>
            </div>
          </div>
          {% if challenge.is_completed %}
            <span style="color:green;font-weight:bold;">Completed ✔️</span>
          {% elif challenge.is_accepted %}
            <button class="complete-challenge-btn" data-challenge-desc="{{ challenge.text|escapejs }}" style="background:#43a047;color:#fff;border:none;border-radius:5px;padding:0.2em 0.8em;cursor:pointer;font-size:0.95em;">Complete Challenge</button>
          {% else %}
            <button class="start-challenge-btn" data-challenge-desc="{{ challenge.text|escapejs }}" style="background:#1976d2;color:#fff;border:none;border-radius:5px;padding:0.2em 0.8em;cursor:pointer;font-size:0.95em;">Start Challenge</button>
          {% endif %}
        </div>
      </li>
    {% endfor %}
  </ul>
{% endif %}

<!-- Latest Activity Feed -->
<div id="latest-activity-feed" style="margin-top:2em;">
  <h3>Latest House Activity</h3>
  <ul id="activity-feed-list" style="list-style:none;padding-left:0;"></ul>
</div>

<!-- Challenge completion confirmation -->
<div id="challenge-complete-popup" style="display:none;position:fixed;top:30%;left:50%;transform:translate(-50%,-50%);background:#43a047;color:#fff;padding:2em 2.5em;border-radius:16px;box-shadow:0 4px 24px #0002;font-size:1.3em;z-index:9999;text-align:center;">
  <div style="font-size:2.5em;">🎉</div>
  <div id="challenge-complete-message">Challenge completed!</div>
</div>

{# Badges #}
{% if badges %}
  <h2>House Badges</h2>
  <div style="display:flex;flex-wrap:wrap;gap:1em;">
    {% for badge in badges %}
      <div style="background:#f7fafd;border:1px solid #4fc3f7;border-radius:8px;padding:0.7em 1.2em;min-width:120px;text-align:center;">
        <div style="font-size:2em;">{{ badge.emoji }}</div>
        <div style="font-weight:bold;">{{ badge.name }}</div>
        <div style="font-size:0.95em;color:#888;">{{ badge.desc }}</div>
        {% if badge.id in user_badge_ids %}<span style="color:green;">Unlocked ✔️</span>{% else %}<span style="color:#aaa;">Locked 🔒</span>{% endif %}
      </div>
    {% endfor %}
  </div>
{% endif %}

{# Leaderboard #}
<h2>House Leaderboard</h2>
{% if house_members %}
  <ol>
    {% for member in house_members %}
      <li>{{ member.username }} - {{ member.points }} pts</li>
    {% endfor %}
  </ol>
{% else %}
  <p>No members yet.</p>
{% endif %}

{# Progress Bars #}
<div style="margin:2em 0;">
  <div><strong>Your Workouts This Week:</strong> {{ user_workouts_this_week }}</div>
  <div style="background:#e0e7ef;height:8px;border-radius:4px;overflow:hidden;margin-bottom:8px;width:200px;">
    <div style="background:linear-gradient(90deg,#4fc3f7,#81d4fa);height:100%;width:{{ workouts_progress_percent }}%;transition:width 0.5s;"></div>
  </div>
  <div><strong>Your Streak:</strong> {{ user_streak }} days</div>
  <div style="background:#e0e7ef;height:8px;border-radius:4px;overflow:hidden;margin-bottom:8px;width:200px;">
    <div style="background:linear-gradient(90deg,#81d4fa,#4fc3f7);height:100%;width:{{ streak_progress_percent }}%;transition:width 0.5s;"></div>
  </div>
  <div><strong>House Points Progress:</strong> {{ user_house_points }} pts</div>
  <div style="background:#e0e7ef;height:8px;border-radius:4px;overflow:hidden;margin-bottom:8px;width:200px;">
    <div style="background:linear-gradient(90deg,#4fc3f7,#1976d2);height:100%;width:{{ house_points_progress_percent }}%;transition:width 0.5s;"></div>
  </div>
</div>

{# Motivational Quote #}
<div style="margin:1.5em 0;font-size:1.1em;color:#1976d2;"><em>{{ motivational_quote }}</em></div>

<div id="house-badge-celebration" style="display:none;text-align:center;margin-top:2em;"></div>
<script>
function updateHouseDetail() {
  fetch('/user_progress_api/')
    .then(r => r.json())
    .then(data => {
      document.getElementById('house-detail-points').textContent = data.house_points;
      // Optionally update other stats
    });
}
function checkHouseBadges() {
  fetch('/user_profile_api/')
    .then(r => r.json())
    .then(data => {
      // For demo: show a celebration if house_points >= 500
      const housePoints = parseInt(document.getElementById('house-detail-points').textContent);
      if (housePoints >= 500) {
        showHouseBadgeCelebration('500+ House Points!');
      }
    });
}
function showHouseBadgeCelebration(text) {
  const el = document.getElementById('house-badge-celebration');
  el.innerHTML = `<div style='font-size:2.5em;'>🎉🏆</div><div style='font-size:1.3em;margin:0.5em 0;'>${text}</div>`;
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 5000);
}

// Accept first challenge button logic
const acceptBtn = document.getElementById('accept-first-challenge-btn');
if (acceptBtn) {
  acceptBtn.addEventListener('click', function() {
    const desc = acceptBtn.getAttribute('data-challenge-desc');
    fetch('/accept-challenge/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ description: desc, xp: 10 })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success || data.message === 'Challenge accepted!') {
        window.location.reload();
      } else {
        alert(data.error || 'Could not accept challenge.');
      }
    });
  });
}

// Start challenge button logic (for all unaccepted challenges)
Array.from(document.getElementsByClassName('start-challenge-btn')).forEach(function(btn) {
  btn.addEventListener('click', function() {
    const desc = btn.getAttribute('data-challenge-desc');
    fetch('/accept-challenge/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ description: desc, xp: 10 })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success || data.message === 'Challenge accepted!') {
        window.location.reload();
      } else {
        alert(data.error || 'Could not start challenge.');
      }
    });
  });
});

// Complete challenge button logic (manual completion)
Array.from(document.getElementsByClassName('complete-challenge-btn')).forEach(function(btn) {
  btn.addEventListener('click', function() {
    const desc = btn.getAttribute('data-challenge-desc');
    fetch('/complete-challenge/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ description: desc, xp: 10 })
    })
    .then(r => r.json())
    .then(data => {
      console.log('Complete challenge response:', data);
      if (data.status === 'completed' || (data.message && data.message.toLowerCase().includes('completed'))) {
        showChallengeCompletePopup('Challenge completed!');
        setTimeout(() => { window.location.reload(); }, 1800);
      } else if (data.error) {
        alert(data.error || 'Could not complete challenge.');
      } else {
        alert('Unexpected response. See console for details.');
        console.log(data);
      }
    })
    .catch(err => {
      alert('Network or server error. See console for details.');
      console.error('Fetch error:', err);
    });
  });
});

// Show challenge complete popup/animation
function showChallengeCompletePopup(msg) {
  const popup = document.getElementById('challenge-complete-popup');
  document.getElementById('challenge-complete-message').textContent = msg;
  popup.style.display = 'block';
  setTimeout(() => { popup.style.display = 'none'; }, 1500);
}

// Animate challenge progress bars
window.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.challenge-progress-fill').forEach(function(bar) {
    let status = bar.getAttribute('data-status');
    let target = 0;
    if (status === 'completed') target = 100;
    else if (status === 'in_progress') target = 50;
    else target = 0;
    setTimeout(function() {
      bar.style.width = target + '%';
    }, 200);
  });
});

// Fetch and display latest activity feed
function loadActivityFeed() {
  fetch('/activity-feed/')
    .then(r => r.json())
    .then(data => {
      const list = document.getElementById('activity-feed-list');
      list.innerHTML = '';
      if (data.feed && data.feed.length > 0) {
        data.feed.forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = `<span style='color:#1976d2;font-weight:bold;'>${item.user}</span> ${item.action} <span style='color:#333;'>${item.description}</span> <span style='color:#888;font-size:0.95em;'>${new Date(item.created_at).toLocaleString()}</span>`;
          list.appendChild(li);
        });
      } else {
        list.innerHTML = '<li style="color:#888;">No recent activity yet.</li>';
      }
    });
}

document.addEventListener('DOMContentLoaded', function() {
  updateHouseDetail();
  checkHouseBadges();
  loadActivityFeed();
});
</script>
{% endblock %}
