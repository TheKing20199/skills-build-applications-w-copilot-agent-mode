{% extends 'base.html' %}

{% block title %}Submit Activity - OctoFit Tracker{% endblock %}

{% block content %}
<h1 class="banner dynamic-contrast">Submit Fitness Activity</h1>
<form method="post" id="activity-form" aria-label="Submit a new fitness activity">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" title="Submit your activity and earn points!" aria-label="Submit activity">Submit</button>
    <span id="form-help" style="margin-left:10px;cursor:pointer;" title="Need help? Ask OctoCoach!" aria-label="Get help from OctoCoach">&#129302;</span>
</form>
<a href="/" class="back-button" aria-label="Back to League">&#128260; Back to League</a>

<div id="activity-feedback" class="feedback" style="display:none;"></div>

{% if coaching_msg %}
  <div style="background:#e3f7fc;border:1px solid #4fc3f7;border-radius:8px;padding:1em 1.2em;margin-bottom:1.2em;font-size:1.1em;">
    <b>OctoCoach says:</b> <span>{{ coaching_msg }}</span>
  </div>
{% endif %}

{% if recommendations %}
<div class="recommendations dynamic-contrast" title="Personalized workout suggestions for you!">
    <h2>Recommended for You</h2>
    <ul>
        <li><strong>Balance:</strong> 9d8 {{ recommendations.balance }} <button class="accept-challenge" data-description="{{ recommendations.balance }}" data-xp="10" title="Accept this balance challenge">Accept</button></li>
        <li><strong>Challenge:</strong> 3af {{ recommendations.challenge }} <button class="accept-challenge" data-description="{{ recommendations.challenge }}" data-xp="15" title="Accept this challenge">Accept</button></li>
        <li><strong>House Boost:</strong> 3cbe0f {{ recommendations.house_boost }} <button class="accept-challenge" data-description="{{ recommendations.house_boost }}" data-xp="20" title="Accept this house boost">Accept</button></li>
    </ul>
</div>
{% endif %}

{% if feedback %}
<div class="feedback dynamic-contrast">
    <h2>CoachBot Feedback</h2>
    <p>{{ feedback }}</p>
</div>
{% endif %}

<!-- House-based Challenge Suggestions -->
<div id="house-challenges" class="recommendations dynamic-contrast" style="margin-top:2em;display:none;">
  <h2>House Challenge Suggestions</h2>
  <ul id="challenge-list"></ul>
</div>

<script>
// Show feedback after submit
const form = document.getElementById('activity-form');
form.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) submitBtn.disabled = true;
    fetch('', {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(async response => {
        let data;
        try { data = await response.json(); } catch { data = {}; }
        const feedback = document.getElementById('activity-feedback');
        if (response.ok && data.success) {
            feedback.textContent = data.message || 'Activity submitted! You earned points!';
            feedback.style.display = 'block';
            feedback.classList.add('dynamic-contrast');
            if (window.markChecklistStep) markChecklistStep('activity');
            if (window.launchConfetti) launchConfetti();
            updateProgress(data.workouts_this_week, data.streak, data.house_points);
            persistChecklist('activity');
            showToast('Activity submitted! Progress updated.');
            // Optionally, update dashboard/house stats in real time if on same page
            if (window.refreshHouseStats) window.refreshHouseStats();
        } else {
            showError((data && data.error) ? data.error : 'There was a problem submitting your activity.');
        }
        if (submitBtn) submitBtn.disabled = false;
    })
    .catch(() => {
        showError('Network error. Please try again.');
        if (submitBtn) submitBtn.disabled = false;
    });
});

// --- Progress update logic ---
function updateProgress(workouts, streak, housePoints) {
    const w = document.getElementById('workouts-this-week');
    const s = document.getElementById('current-streak');
    const h = document.getElementById('house-points-earned');
    if (w) w.textContent = workouts;
    if (s) s.textContent = streak;
    if (h) h.textContent = housePoints;
}

// --- Checklist persistence ---
function persistChecklist(step) {
    let checklist = JSON.parse(localStorage.getItem('octofitChecklist') || '{}');
    checklist[step] = true;
    localStorage.setItem('octofitChecklist', JSON.stringify(checklist));
}
function restoreChecklist() {
    let checklist = JSON.parse(localStorage.getItem('octofitChecklist') || '{}');
    Object.keys(checklist).forEach(step => {
        if (checklist[step] && window.markChecklistStep) markChecklistStep(step);
    });
}
document.addEventListener('DOMContentLoaded', restoreChecklist);

// --- Toast message ---
function showToast(msg) {
    let toast = document.getElementById('octofit-toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'octofit-toast';
        toast.style.position = 'fixed';
        toast.style.bottom = '40px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.background = 'rgba(32,32,32,0.95)';
        toast.style.color = '#fff';
        toast.style.padding = '14px 32px';
        toast.style.borderRadius = '16px';
        toast.style.fontSize = '1.1em';
        toast.style.zIndex = 2000;
        toast.style.boxShadow = '0 4px 24px #0004';
        document.body.appendChild(toast);
    }
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, 2200);
}

// Tooltip for help icon
const helpIcon = document.getElementById('form-help');
helpIcon.addEventListener('click', function() {
    document.getElementById('octocoach-panel').style.display = 'block';
    document.getElementById('octocoach-input').value = 'How do I fill out the activity form?';
    document.getElementById('octocoach-send').click();
});
// Accept challenge logic
[...document.querySelectorAll('.accept-challenge')].forEach(button => {
    button.addEventListener('click', () => {
        const description = button.getAttribute('data-description');
        const xp = button.getAttribute('data-xp');
        fetch('/accept-challenge/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ description, xp })
        }).then(response => {
            if (response.ok) {
                if (window.markChecklistStep) markChecklistStep('challenge');
                if (window.launchConfetti) launchConfetti();
                alert('Challenge accepted! Progress updated.');
            } else {
                alert('Failed to accept challenge.');
            }
        });
    });
});

// Use backend-passed activities for challenge suggestions and logic
const activitiesArr = JSON.parse(document.getElementById('house-activities').textContent);
const challengesArr = JSON.parse(document.getElementById('house-challenges').textContent);

// --- House-based challenge suggestions ---
(function() {
  // You must pass the user's house to the template context as user_house
  const house = "{{ user_house|default:'' }}".trim();
  if (house && challengesArr[house]) {
    const challengeList = document.getElementById('challenge-list');
    challengeList.innerHTML = '';
    challengesArr[house].forEach((challenge, idx) => {
      const li = document.createElement('li');
      li.innerHTML = `<strong>Challenge ${idx+1}:</strong> ${challenge} <button class="accept-challenge" data-description="${challenge}" data-xp="10" title="Accept this challenge">Accept</button>`;
      challengeList.appendChild(li);
    });
    document.getElementById('house-challenges').style.display = 'block';
    // Wire up accept buttons
    challengeList.querySelectorAll('.accept-challenge').forEach(button => {
      button.addEventListener('click', () => {
        const description = button.getAttribute('data-description');
        const xp = button.getAttribute('data-xp');
        fetch('/accept-challenge/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({ description, xp })
        }).then(response => {
          if (response.ok) {
            if (window.markChecklistStep) markChecklistStep('challenge');
            if (window.launchConfetti) launchConfetti();
            alert('Challenge accepted! Progress updated.');
          } else {
            alert('Failed to accept challenge.');
          }
        });
      });
    });
  }
})();
</script>
<style>
@media (max-width: 600px) {
  form, .recommendations, .feedback, .back-button {
    font-size: 1em;
    padding: 1em 0.5em;
  }
  button, .back-button { font-size: 1em; padding: 0.7em 1.2em; }
}
button:focus, .back-button:focus {
  outline: 3px solid #1976d2;
  outline-offset: 2px;
  box-shadow: 0 0 0 2px #90caf9;
}
</style>
{% endblock %}